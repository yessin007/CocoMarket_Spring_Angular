import { isPlatformServer } from '@angular/common';
import { Hooks } from '../types';
import { addCssClassName, cssClassNames, hasCssClassName, removeCssClassName } from '../util/css.util';
import { isChildOfPicture, isImageElement, setImage, setImageAndSourcesToDefault, setImageAndSourcesToError, setImageAndSourcesToLazy, setSourcesToLazy } from '../util/util';
export class SharedHooks extends Hooks {
    setup(attributes) {
        setImageAndSourcesToDefault(attributes.element, attributes.defaultImagePath, attributes.useSrcset);
        if (attributes.imagePath) {
            addCssClassName(attributes.element, cssClassNames.loading);
        }
        if (hasCssClassName(attributes.element, cssClassNames.loaded)) {
            removeCssClassName(attributes.element, cssClassNames.loaded);
        }
    }
    finally(attributes) {
        addCssClassName(attributes.element, cssClassNames.loaded);
        removeCssClassName(attributes.element, cssClassNames.loading);
    }
    loadImage(attributes) {
        if (this.skipLazyLoading(attributes)) {
            // Set the image right away for bots for better SEO
            return [attributes.imagePath];
        }
        const { element, useSrcset, imagePath, decode } = attributes;
        let img;
        if (isImageElement(element) && isChildOfPicture(element)) {
            const parentClone = element.parentNode.cloneNode(true);
            img = parentClone.getElementsByTagName('img')[0];
            setSourcesToLazy(img);
            setImage(img, imagePath, useSrcset);
        }
        else {
            img = new Image();
            if (isImageElement(element) && element.referrerPolicy) {
                img.referrerPolicy = element.referrerPolicy;
            }
            if (isImageElement(element) && element.sizes) {
                img.sizes = element.sizes;
            }
            if (useSrcset && 'srcset' in img) {
                img.srcset = imagePath;
            }
            else {
                img.src = imagePath;
            }
        }
        if (decode && img.decode) {
            return img.decode().then(() => imagePath);
        }
        return new Promise((resolve, reject) => {
            img.onload = () => resolve(imagePath);
            img.onerror = () => reject(null);
        });
    }
    setErrorImage(error, attributes) {
        const { element, useSrcset, errorImagePath } = attributes;
        setImageAndSourcesToError(element, errorImagePath, useSrcset);
        addCssClassName(element, cssClassNames.failed);
    }
    setLoadedImage(imagePath, attributes) {
        const { element, useSrcset } = attributes;
        setImageAndSourcesToLazy(element, imagePath, useSrcset);
    }
    isDisabled() {
        // Disable if SSR and the user isn't a bot
        return isPlatformServer(this.platformId) && !this.isBot();
    }
    skipLazyLoading(attributes) {
        return this.isBot(attributes);
    }
    isBot(attributes) {
        if (this.navigator?.userAgent) {
            return /googlebot|bingbot|yandex|baiduspider|facebookexternalhit|twitterbot|rogerbot|linkedinbot|embedly|quora\ link\ preview|showyoubot|outbrain|pinterest\/0\.|pinterestbot|slackbot|vkShare|W3C_Validator|whatsapp|duckduckbot|prerender/i.test(this.navigator.userAgent);
        }
        return false;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaG9va3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvc2hhcmVkLWhvb2tzL2hvb2tzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRW5ELE9BQU8sRUFBYyxLQUFLLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDN0MsT0FBTyxFQUFFLGVBQWUsRUFBRSxhQUFhLEVBQUUsZUFBZSxFQUFFLGtCQUFrQixFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDdkcsT0FBTyxFQUFFLGdCQUFnQixFQUFFLGNBQWMsRUFBRSxRQUFRLEVBQUUsMkJBQTJCLEVBQUUseUJBQXlCLEVBQUUsd0JBQXdCLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFFOUssTUFBTSxPQUFnQixXQUFlLFNBQVEsS0FBUTtJQUNuRCxLQUFLLENBQUMsVUFBc0I7UUFDMUIsMkJBQTJCLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxVQUFVLENBQUMsZ0JBQWdCLEVBQUUsVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ25HLElBQUksVUFBVSxDQUFDLFNBQVMsRUFBRTtZQUN4QixlQUFlLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDNUQ7UUFFRCxJQUFJLGVBQWUsQ0FBQyxVQUFVLENBQUMsT0FBTyxFQUFFLGFBQWEsQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUM3RCxrQkFBa0IsQ0FBQyxVQUFVLENBQUMsT0FBTyxFQUFFLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUM5RDtJQUNILENBQUM7SUFFRCxPQUFPLENBQUMsVUFBc0I7UUFDNUIsZUFBZSxDQUFDLFVBQVUsQ0FBQyxPQUFPLEVBQUUsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzFELGtCQUFrQixDQUFDLFVBQVUsQ0FBQyxPQUFPLEVBQUUsYUFBYSxD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QztJQUNoQyxDQUFDO0lBRUQsS0FBSyxDQUFDLFVBQXVCO1FBQzNCLElBQUksSUFBSSxDQUFDLFNBQVMsRUFBRSxTQUFTLEVBQUU7WUFDN0IsT0FBTyxzT0FBc08sQ0FBQyxJQUFJLENBQ2hQLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUN6QixDQUFDO1NBQ0g7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGlzUGxhdGZvcm1TZXJ2ZXIgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZUlucHV0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBBdHRyaWJ1dGVzLCBIb29rcyB9IGZyb20gJy4uL3R5cGVzJztcbmltcG9ydCB7IGFkZENzc0NsYXNzTmFtZSwgY3NzQ2xhc3NOYW1lcywgaGFzQ3NzQ2xhc3NOYW1lLCByZW1vdmVDc3NDbGFzc05hbWUgfSBmcm9tICcuLi91dGlsL2Nzcy51dGlsJztcbmltcG9ydCB7IGlzQ2hpbGRPZlBpY3R1cmUsIGlzSW1hZ2VFbGVtZW50LCBzZXRJbWFnZSwgc2V0SW1hZ2VBbmRTb3VyY2VzVG9EZWZhdWx0LCBzZXRJbWFnZUFuZFNvdXJjZXNUb0Vycm9yLCBzZXRJbWFnZUFuZFNvdXJjZXNUb0xhenksIHNldFNvdXJjZXNUb0xhenkgfSBmcm9tICcuLi91dGlsL3V0aWwnO1xuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgU2hhcmVkSG9va3M8RT4gZXh0ZW5kcyBIb29rczxFPiB7XG4gIHNldHVwKGF0dHJpYnV0ZXM6IEF0dHJpYnV0ZXMpOiB2b2lkIHtcbiAgICBzZXRJbWFnZUFuZFNvdXJjZXNUb0RlZmF1bHQoYXR0cmlidXRlcy5lbGVtZW50LCBhdHRyaWJ1dGVzLmRlZmF1bHRJbWFnZVBhdGgsIGF0dHJpYnV0ZXMudXNlU3Jjc2V0KTtcbiAgICBpZiAoYXR0cmlidXRlcy5pbWFnZVBhdGgpIHtcbiAgICAgIGFkZENzc0NsYXNzTmFtZShhdHRyaWJ1dGVzLmVsZW1lbnQsIGNzc0NsYXNzTmFtZXMubG9hZGluZyk7XG4gICAgfVxuXG4gICAgaWYgKGhhc0Nzc0NsYXNzTmFtZShhdHRyaWJ1dGVzLmVsZW1lbnQsIGNzc0NsYXNzTmFtZXMubG9hZGVkKSkge1xuICAgICAgcmVtb3ZlQ3NzQ2xhc3NOYW1lKGF0dHJpYnV0ZXMuZWxlbWVudCwgY3NzQ2xhc3NOYW1lcy5sb2FkZWQpO1xuICAgIH1cbiAgfVxuXG4gIGZpbmFsbHkoYXR0cmlidXRlczogQXR0cmlidXRlcyk6IHZvaWQge1xuICAgIGFkZENzc0NsYXNzTmFtZShhdHRyaWJ1dGVzLmVsZW1lbnQsIGNzc0NsYXNzTmFtZXMubG9hZGVkKTtcbiAgICByZW1vdmVDc3NDbGFzc05hbWUoYXR0cmlidXRlcy5lbGVtZW50LCBjc3NDbGFzc05hbWVzLmxvYWRpbmcpO1xuICB9XG5cbiAgbG9hZEltYWdlKGF0dHJpYnV0ZXM6IEF0dHJpYnV0ZXMpOiBPYnNlcnZhYmxlSW5wdXQ8c3RyaW5nPiB7XG4gICAgaWYgKHRoaXMuc2tpcExhenlMb2FkaW5nKGF0dHJpYnV0ZXMpKSB7XG4gICAgICAvLyBTZXQgdGhlIGltYWdlIHJpZ2h0IGF3YXkgZm9yIGJvdHMgZm9yIGJldHRlciBTRU9cbiAgICAgIHJldHVybiBbYXR0cmlidXRlcy5pbWFnZVBhdGhdO1xuICAgIH1cbiAgICBjb25zdCB7IGVsZW1lbnQsIHVzZVNyY3NldCwgaW1hZ2VQYXRoLCBkZWNvZGUgfSA9IGF0dHJpYnV0ZXM7XG4gICAgbGV0IGltZzogSFRNTEltYWdlRWxlbWVudDtcbiAgICBpZiAoaXNJbWFnZUVsZW1lbnQoZWxlbWVudCkgJiYgaXNDaGlsZE9mUGljdHVyZShlbGVtZW50KSkge1xuICAgICAgY29uc3QgcGFyZW50Q2xvbmUgPSBlbGVtZW50LnBhcmVudE5vZGUhLmNsb25lTm9kZSh0cnVlKSBhcyBIVE1MUGljdHVyZUVsZW1lbnQ7XG4gICAgICBpbWcgPSBwYXJlbnRDbG9uZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaW1nJylbMF07XG4gICAgICBzZXRTb3VyY2VzVG9MYXp5KGltZyk7XG4gICAgICBzZXRJbWFnZShpbWcsIGltYWdlUGF0aCwgdXNlU3Jjc2V0KTtcbiAgICB9IGVsc2Uge1xuICAgICAgaW1nID0gbmV3IEltYWdlKCk7XG4gICAgICBpZiAoaXNJbWFnZUVsZW1lbnQoZWxlbWVudCkgJiYgZWxlbWVudC5yZWZlcnJlclBvbGljeSkge1xuICAgICAgICBpbWcucmVmZXJyZXJQb2xpY3kgPSBlbGVtZW50LnJlZmVycmVyUG9saWN5O1xuICAgICAgfVxuICAgICAgaWYgKGlzSW1hZ2VFbGVtZW50KGVsZW1lbnQpICYmIGVsZW1lbnQuc2l6ZXMpIHtcbiAgICAgICAgaW1nLnNpemVzID0gZWxlbWVudC5zaXplcztcbiAgICAgIH1cbiAgICAgIGlmICh1c2VTcmNzZXQgJiYgJ3NyY3NldCcgaW4gaW1nKSB7XG4gICAgICAgIGltZy5zcmNzZXQgPSBpbWFnZVBhdGg7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpbWcuc3JjID0gaW1hZ2VQYXRoO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChkZWNvZGUgJiYgaW1nLmRlY29kZSkge1xuICAgICAgcmV0dXJuIGltZy5kZWNvZGUoKS50aGVuKCgpID0+IGltYWdlUGF0aCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPHN0cmluZz4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgaW1nLm9ubG9hZCA9ICgpID0+IHJlc29sdmUoaW1hZ2VQYXRoKTtcbiAgICAgIGltZy5vbmVycm9yID0gKCkgPT4gcmVqZWN0KG51bGwpO1xuICAgIH0pO1xuICB9XG5cbiAgc2V0RXJyb3JJbWFnZShlcnJvcjogRXJyb3IsIGF0dHJpYnV0ZXM6IEF0dHJpYnV0ZXMpOiB2b2lkIHtcbiAgICBjb25zdCB7IGVsZW1lbnQsIHVzZVNyY3NldCwgZXJyb3JJbWFnZVBhdGggfSA9IGF0dHJpYnV0ZXM7XG4gICAgc2V0SW1hZ2VBbmRTb3VyY2VzVG9FcnJvcihlbGVtZW50LCBlcnJvckltYWdlUGF0aCwgdXNlU3Jjc2V0KTtcbiAgICBhZGRDc3NDbGFzc05hbWUoZWxlbWVudCwgY3NzQ2xhc3NOYW1lcy5mYWlsZWQpO1xuICB9XG5cbiAgc2V0TG9hZGVkSW1hZ2UoaW1hZ2VQYXRoOiBzdHJpbmcsIGF0dHJpYnV0ZXM6IEF0dHJpYnV0ZXMpOiB2b2lkIHtcbiAgICBjb25zdCB7IGVsZW1lbnQsIHVzZVNyY3NldCB9ID0gYXR0cmlidXRlcztcbiAgICBzZXRJbWFnZUFuZFNvdXJjZXNUb0xhenkoZWxlbWVudCwgaW1hZ2VQYXRoLCB1c2VTcmNzZXQpO1xuICB9XG5cbiAgaXNEaXNhYmxlZCgpOiBib29sZWFuIHtcbiAgICAvLyBEaXNhYmxlIGlmIFNTUiBhbmQgdGhlIHVzZXIgaXNuJ3QgYSBib3RcbiAgICByZXR1cm4gaXNQbGF0Zm9ybVNlcnZlcih0aGlzLnBsYXRmb3JtSWQpICYmICF0aGlzLmlzQm90KCk7XG4gIH1cblxuICBza2lwTGF6eUxvYWRpbmcoYXR0cmlidXRlczogQXR0cmlidXRlcyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmlzQm90KGF0dHJpYnV0ZXMpO1xuICB9XG5cbiAgaXNCb3QoYXR0cmlidXRlcz86IEF0dHJpYnV0ZXMpOiBib29sZWFuIHtcbiAgICBpZiAodGhpcy5uYXZpZ2F0b3I/LnVzZXJBZ2VudCkge1xuICAgICAgcmV0dXJuIC9nb29nbGVib3R8YmluZ2JvdHx5YW5kZXh8YmFpZHVzcGlkZXJ8ZmFjZWJvb2tleHRlcm5hbGhpdHx0d2l0dGVyYm90fHJvZ2VyYm90fGxpbmtlZGluYm90fGVtYmVkbHl8cXVvcmFcXCBsaW5rXFwgcHJldmlld3xzaG93eW91Ym90fG91dGJyYWlufHBpbnRlcmVzdFxcLzBcXC58cGludGVyZXN0Ym90fHNsYWNrYm90fHZrU2hhcmV8VzNDX1ZhbGlkYXRvcnx3aGF0c2FwcHxkdWNrZHVja2JvdHxwcmVyZW5kZXIvaS50ZXN0KFxuICAgICAgICB0aGlzLm5hdmlnYXRvci51c2VyQWdlbnRcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufVxuIl19